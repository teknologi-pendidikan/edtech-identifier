# EdTech Identifier System - URL Rewriting Rules
# Enables clean identifier resolution URLs

RewriteEngine On

# Security: Block access to sensitive files
<FilesMatch "\.(md|sql|zip)$">
    Order deny,allow
    Deny from all
</FilesMatch>

# Block access to includes directory
RewriteRule ^includes/ - [F,L]

# Block access to old directory  
RewriteRule ^old/ - [F,L]

# Admin area - let it handle normally
RewriteRule ^admin/ - [L]

# Assets (CSS, JS, images) - let them load normally
RewriteRule ^assets/ - [L]

# Debug and test files - let them load normally
RewriteRule ^(debug|test-identifiers|direct-test|prefix-test)\.php$ - [L]

# Main site files - let them load normally
RewriteRule ^(index|resolve)\.php$ - [L]

# Direct identifier resolution
# Pattern: domain.tld/prefix/suffix -> resolve.php
# Examples:
# - urn.edtech.or.id/edtech.journal/2025.001
# - urn.edtech.or.id/ej/2025.001
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^([a-zA-Z0-9\.]+)/(.+)$ resolve.php [L,QSA]

# Fallback: if someone visits /resolve/identifier
RewriteRule ^resolve/(.+)$ resolve.php [L,QSA]

# Optional: Redirect root to main interface
# RewriteRule ^$ index.php [L]

# Add proper headers for identifier resolution
<IfModule mod_headers.c>
    # Cache policy for identifier resolutions
    <FilesMatch "resolve\.php">
        Header set Cache-Control "no-cache, must-revalidate"
        Header set X-Robots-Tag "noindex, nofollow"
    </FilesMatch>
    
    # Add CORS headers if needed for API access
    <FilesMatch "\.(php)$">
        Header add Access-Control-Allow-Origin "*"
        Header add Access-Control-Allow-Headers "Content-Type"
    </FilesMatch>
</IfModule>

# Optional: Force HTTPS (uncomment if using SSL)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Add proper MIME types
<IfModule mod_mime.c>
    AddType application/json .json
    AddType text/plain .txt
    AddType text/csv .csv
</IfModule>

# Compression for better performance
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>